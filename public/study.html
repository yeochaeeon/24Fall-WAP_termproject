<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤í„°ë”” í˜ì´ì§€</title>
    <link rel="stylesheet" href="/study.css">
</head>
<body>
<div class="study-page">
    <div class="study-title">
        <h1 id="study-title">ìŠ¤í„°ë”” ì œëª© ë¡œë”© ì¤‘...</h1>
    </div>
    <h3 id="study-creator">âœï¸ìŠ¤í„°ë””ì¥: ë¡œë”© ì¤‘...âœï¸</h3>

    <div class="tasks">
        <h2 style="background: rgba(214,225,255,0.48); padding:5px; width: 25%; border-radius: 10px;">ğŸ“˜ ê³¼ì œ ëª©ë¡</h2>
        <ul id="tasks-list">
            <li>ê³¼ì œ ë¡œë”© ì¤‘...</li>
        </ul>
        <form id="task-form">
            <h3>ê³¼ì œ ë“±ë¡</h3>
            <div class="detailForm">
                <input type="text" name="title" id="task-title" placeholder="ê³¼ì œ ì œëª©" required>
                <textarea name="description" id="task-description" placeholder="ê³¼ì œ ì„¤ëª…" required></textarea>
                <label for="task-dueDate"><strong>ì˜¤ë¥¸ìª½ ë‹¬ë ¥ ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ë§ˆê°ì¼ì„ ë“±ë¡í•˜ì„¸ìš”</strong></label>
                <input type="date" name="dueDate" id="task-dueDate" required>
                <button type="submit">ë“±ë¡</button>
            </div>
        </form>
    </div>

    <div class="notices">
        <h2 style="background: rgba(214,225,255,0.48); padding:5px; width: 25%; border-radius: 10px;">ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
        <ul id="notices-list">
            <li>ê³µì§€ ë¡œë”© ì¤‘...</li>
        </ul>
        <form id="notice-form">
            <h3>ê³µì§€ ë“±ë¡</h3>
            <div class="detailForm">
                <input type="text" name="title" id="notice-title" placeholder="ê³µì§€ ì œëª©" required>
                <textarea name="content" id="notice-content" placeholder="ê³µì§€ ë‚´ìš©" required></textarea>
                <button type="submit">ë“±ë¡</button>
            </div>
        </form>
    </div>
</div>
<script>
    // ìŠ¤í„°ë”” ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const studyId = window.location.pathname.split('/').pop();

    async function fetchStudyData() {
        try {
            // rest api ë°ì´í„° ìš”ì²­
            const studyResponse = await fetch(`/api/study/${studyId}`);
            const tasksResponse = await fetch(`/api/study/${studyId}/tasks`);
            const noticesResponse = await fetch(`/api/study/${studyId}/notices`);

            if (!studyResponse.ok || !tasksResponse.ok || !noticesResponse.ok) {
                throw new Error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }

            const { study } = await studyResponse.json();
            const { tasks } = await tasksResponse.json();
            const { notices } = await noticesResponse.json();
            // ë Œë”ë§
            renderStudy(study);
            renderTasks(tasks);
            renderNotices(notices);
        } catch (error) {
            console.error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
    }
    // ê³¼ì œ ëª©ë¡ ë Œë”ë§
    function renderTasks(tasks) {
        const tasksList = document.getElementById('tasks-list');
        tasksList.innerHTML = tasks.map(task => `
        <li>
            <strong>${task.title}</strong> [ ë§ˆê°ì¼: ${task.dueDate} ]
            <p>${task.description}</p>
        </li>
    `).join('');
    }

    // ìŠ¤í„°ë”” ì •ë³´ ë Œë”ë§
    function renderStudy(study) {
        document.getElementById('study-title').textContent = `${study.title} ìŠ¤í„°ë””`;
        document.getElementById('study-creator').textContent = `âœï¸ìŠ¤í„°ë””ì¥: ${study.creatorNick}âœï¸`;
    }

    // ê³µì§€ ëª©ë¡ ë Œë”ë§
    function renderNotices(notices) {
        const noticesList = document.getElementById('notices-list');
        noticesList.innerHTML = notices.map(notice => `
            <li>
                <div class="notice">
                    <strong>${notice.title}</strong>
                    <span><strong>ê³µì§€ê²Œì‹œì¼</strong>: ${notice.createdAt}</span>
                </div>
                <p>${notice.content}</p>
            </li>
        `).join('');
    }

    // ê³¼ì œ ë“±ë¡
    document.getElementById('task-form').addEventListener('submit', async function (event) {
        event.preventDefault();

        const task = {
            title: document.getElementById('task-title').value,
            description: document.getElementById('task-description').value,
            dueDate: document.getElementById('task-dueDate').value
        };

        try {
            const response = await fetch(`/api/study/${studyId}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task)
            });

            if (response.ok) {
                alert('ê³¼ì œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchStudyData(); // ëª©ë¡ ê°±ì‹ 
            } else {
                alert('ê³¼ì œ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ê³¼ì œ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
    });

    // ê³µì§€ ë“±ë¡
    document.getElementById('notice-form').addEventListener('submit', async function (event) {
        event.preventDefault();

        const notice = {
            title: document.getElementById('notice-title').value,
            content: document.getElementById('notice-content').value
        };

        try {
            const response = await fetch(`/api/study/${studyId}/notices`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(notice)
            });

            if (response.ok) {
                alert('ê³µì§€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchStudyData(); // ëª©ë¡ ê°±ì‹ 
            } else {
                alert('ê³µì§€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ê³µì§€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
    });

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    fetchStudyData();
</script>
</body>
</html>
